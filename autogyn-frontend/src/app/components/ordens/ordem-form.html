<div class="ordem-form-container">
  <h2>Cadastro de Ordem de Serviço</h2>

  <form [formGroup]="ordemForm" (ngSubmit)="onSubmit()" class="p-fluid">

    <!-- Veículo -->
    <div class="p-field">
      <label for="veiculoId">Veículo</label>
      <p-select
        [options]="veiculos"
        optionLabel="modelo"
        optionValue="id"
        formControlName="veiculoId"
        placeholder="Selecione o veículo">
      </p-select>
    </div>

    <!-- Cliente -->
    <div class="p-field" *ngIf="clienteSelecionado">
      <label>Cliente</label>
      <input type="text" [value]="clienteSelecionado" pInputText readonly />
    </div>

    <!-- Datas -->
    <div class="p-field-group">
      <div class="p-field">
        <label for="dataAbertura">Data de Abertura</label>
        <p-datepicker formControlName="dataAbertura" showIcon inputId="dataAbertura"></p-datepicker>
      </div>

      <div class="p-field">
        <label for="dataFechamento">Data de Fechamento</label>
        <p-datepicker formControlName="dataFechamento" showIcon inputId="dataFechamento"></p-datepicker>
      </div>
    </div>

    <!-- Status -->
    <div class="p-field">
      <label for="status">Status</label>
      <input id="status" type="text" pInputText formControlName="status" readonly />
    </div>

    <!-- Observações -->
    <div class="p-field">
      <label for="observacoes">Observações</label>
      <textarea id="observacoes" rows="3" pTextarea formControlName="observacoes"></textarea>
    </div>

    <!-- Itens da Ordem -->
    <div formArrayName="itens" class="items-section">
      <h3>Itens da Ordem</h3>
      <button type="button" pButton icon="pi pi-plus" label="Adicionar Item" class="add-item-button" (click)="adicionarItem()"></button>

      <div *ngFor="let item of itens.controls; let i = index" [formGroupName]="i" class="item-card">

        <div class="p-field">
          <label for="pecaEstoqueId">Peça</label>
          <p-select
            [options]="pecas"
            optionLabel="nome"
            optionValue="id"
            formControlName="pecaEstoqueId"
            placeholder="Selecione a peça"
            (onChange)="onPecaSelecionada(i)">
          </p-select>
        </div>

        <div class="p-field">
          <label>Quantidade</label>
          <input type="number" formControlName="quantidade" [max]="getQuantidadeMaxima(i)" min="1" class="form-control" />
          <small class="text-muted">Máximo disponível: {{ getQuantidadeMaxima(i) }}</small>
        </div>

        <div class="p-field">
          <label>Valor Unitário</label>
          <input type="number" pInputText formControlName="valorUnitario" readonly />
        </div>

        <div class="p-field">
          <label>Descrição</label>
          <input pInputText formControlName="descricao" />
        </div>

        <button type="button" pButton icon="pi pi-trash" class="p-button-danger" (click)="removerItem(i)"></button>
      </div>
    </div>

    <!-- Valor total -->
    <div class="p-field">
      <label>Valor Total da Ordem</label>
      <input pInputText [value]="valorTotal | currency:'BRL'" readonly />
    </div>

    <!-- Botões -->
    <div class="button-group">
      <button pButton type="submit" label="Salvar Ordem de Serviço" class="submit-button"></button>
      <button type="button" pButton icon="pi pi-arrow-left" label="Voltar para Lista" class="submit-button" (click)="voltarParaLista()"></button>
    </div>

  </form>
</div>
